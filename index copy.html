<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA4 Test Runner - TradePending</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            color: #e2e8f0;
        }

        .container {
            max-width: 660px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            color: #f1f5f9;
            letter-spacing: -0.5px;
        }

        .header .badge {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: #a5b4fc;
            font-weight: 500;
        }

        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 14px;
            padding: 28px;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            color: #cbd5e1;
        }

        select, input {
            width: 100%;
            padding: 10px 14px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #f1f5f9;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
            appearance: none;
            -webkit-appearance: none;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 34px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        input::placeholder {
            color: #475569;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        button {
            padding: 13px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.3px;
        }

        .btn-run {
            background: #6366f1;
            color: white;
        }

        .btn-run:hover {
            background: #5457e5;
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
        }

        .btn-run:disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-report {
            background: #0f172a;
            color: #a5b4fc;
            border: 1px solid #334155;
        }

        .btn-report:hover {
            border-color: #6366f1;
            color: #c7d2fe;
            background: #1e293b;
        }

        .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
            line-height: 1.5;
        }

        .status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.25);
            color: #86efac;
            display: block;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.25);
            color: #fca5a5;
            display: block;
        }

        .status.info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.25);
            color: #a5b4fc;
            display: block;
        }

        .loader {
            border: 2px solid #334155;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.7s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workflow-list {
            margin-top: 8px;
        }

        .workflow-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }

        .workflow-item:hover {
            border-color: #475569;
        }

        .workflow-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .workflow-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }

        .status-success { background: rgba(34, 197, 94, 0.15); color: #86efac; }
        .status-failure { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
        .status-in_progress { background: rgba(234, 179, 8, 0.15); color: #fde047; }
        .status-queued { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }

        .workflow-run-number {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .workflow-date {
            font-size: 12px;
            color: #64748b;
            margin-left: auto;
            font-family: 'JetBrains Mono', monospace;
        }

        .workflow-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            font-family: 'Inter', sans-serif;
        }

        .tag-report-full {
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
            border-color: rgba(99, 102, 241, 0.25);
        }

        .tag-report-full:hover:not(:disabled) {
            background: rgba(99, 102, 241, 0.25);
            color: #c7d2fe;
        }

        .tag-report-single {
            background: rgba(139, 92, 246, 0.15);
            color: #c4b5fd;
            border-color: rgba(139, 92, 246, 0.25);
        }

        .tag-report-single:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.25);
            color: #ddd6fe;
        }

        .tag-github {
            background: rgba(148, 163, 184, 0.1);
            color: #64748b;
            border-color: rgba(148, 163, 184, 0.15);
        }

        .tag-github:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        .tag-pending {
            background: rgba(234, 179, 8, 0.1);
            color: #fde047;
            border-color: rgba(234, 179, 8, 0.15);
            cursor: default;
        }

        .tag-failed {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.15);
            cursor: default;
        }

        .tag:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            color: #475569;
            font-size: 13px;
            padding: 24px 0;
        }

        .refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #475569;
        }

        .refresh-dot {
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
    </style>
</head>
<body>
    <div class="container">

        <div class="header">
            <h1>‚¨° GA4 Test Runner</h1>
            <span class="badge">TradePending Automation</span>
        </div>

        <div class="card">
            <div class="card-title">Configure & Run</div>

            <div class="form-row">
                <div class="form-group">
                    <label for="environment">Environment</label>
                    <select id="environment">
                        <option value="qa">QA</option>
                        <option value="qaautomation">QA Automation</option>
                        <option value="production">Production</option>
                        <option value="local">Local</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="browser">Browser</label>
                    <select id="browser">
                        <option value="chromium">Chromium</option>
                        <option value="firefox">Firefox</option>
                        <option value="webkit">WebKit</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="feature">Feature</label>
                    <select id="feature" disabled>
                        <option value="GA4">GA4 Analytics</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tags">Tags <span style="color:#475569;">(optional)</span></label>
                    <input type="text" id="tags" placeholder="e.g. @smoke, @Demo">
                </div>
            </div>

            <div class="button-group">
                <button class="btn-run" id="runBtn" onclick="runTests()">‚ñ∂ Run Tests</button>
                <button class="btn-report" onclick="viewReports()">‚äû View Reports</button>
            </div>

            <div id="status" class="status"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div class="card-title" style="margin-bottom:0;">Recent Runs</div>
                <div class="refresh-indicator">
                    <div class="refresh-dot"></div>
                    Live
                </div>
            </div>
            <div id="workflowList" class="workflow-list" style="margin-top:16px;"></div>
        </div>

    </div>

    <script>
        // ============================================================
        // CONFIG ‚Äî replace YOUR_NEW_TOKEN_HERE with your actual token
        // ============================================================
        const GITHUB_TOKEN  = '{{GITHUB_TOKEN}}';
        const GITHUB_OWNER  = 'TradePending';
        const GITHUB_REPO   = 'automation';
        const WORKFLOW_FILE = 'playwright-bdd-ci.yml';

        const API_BASE = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}`;

        const headers = {
            'Authorization': `Bearer ${GITHUB_TOKEN}`,
            'Accept'       : 'application/vnd.github.v3+json',
            'Content-Type' : 'application/json'
        };

        // ============================================================
        // TRIGGER TESTS
        // ============================================================
        async function runTests() {
            const btn = document.getElementById('runBtn');

            const environment = document.getElementById('environment').value;
            const feature     = document.getElementById('feature').value;
            const tags        = document.getElementById('tags').value.trim();
            const browser     = document.getElementById('browser').value;

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Triggering...';
            showStatus('info', '‚è≥ Triggering GA4 tests on GitHub Actions‚Ä¶');

            try {
                const res = await fetch(
                    `${API_BASE}/actions/workflows/${WORKFLOW_FILE}/dispatches`,
                    {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            ref: 'master',
                            inputs: {
                                environments: environment,
                                feature     : feature,
                                tags        : tags,
                                browser     : browser,
                                parallel    : '2'
                            }
                        })
                    }
                );

                if (res.status === 204) {
                    showStatus('success',
                        `‚úÖ Tests triggered! <span style="color:#64748b;">env: ${environment} | feature: ${feature}${tags ? ' | tags: ' + tags : ''}</span><br>
                         <small>Reports will appear below once the run completes.</small>`
                    );
                    setTimeout(loadWorkflows, 3000);
                } else {
                    const err = await res.json();
                    throw new Error(err.message || 'Unknown error');
                }
            } catch (e) {
                showStatus('error', `‚ùå ${e.message}`);
            } finally {
                btn.disabled  = false;
                btn.innerHTML = '‚ñ∂ Run Tests';
            }
        }

        // ============================================================
        // REFRESH RUNS LIST
        // ============================================================
        async function viewReports() {
            showStatus('info', '‚è≥ Refreshing runs‚Ä¶');
            try {
                await loadWorkflows();
                showStatus('success', '‚úÖ Runs refreshed. Click a report button to download.');
            } catch (e) {
                showStatus('error', `‚ùå ${e.message}`);
            }
        }

        // ============================================================
        // LOAD WORKFLOW RUNS
        // ============================================================
        async function loadWorkflows() {
            const container = document.getElementById('workflowList');

            const res  = await fetch(
                `${API_BASE}/actions/workflows/${WORKFLOW_FILE}/runs?per_page=10`,
                { headers }
            );
            const data = await res.json();

            if (!res.ok || !data.workflow_runs) {
                container.innerHTML = '<div class="empty-state">Could not load runs.</div>';
                return;
            }

            if (data.workflow_runs.length === 0) {
                container.innerHTML = '<div class="empty-state">No runs yet.</div>';
                return;
            }

            container.innerHTML = '';

            data.workflow_runs.forEach(run => {
                const isCompleted = run.status === 'completed';
                const isSuccess   = isCompleted && run.conclusion === 'success';
                const isRunning   = run.status === 'in_progress' || run.status === 'queued';
                const statusKey   = isCompleted ? run.conclusion : run.status;
                const date        = new Date(run.created_at).toLocaleString();

                let links = '';

                if (isCompleted) {
                    // Show download buttons for all completed runs (Allure generates even on failure)
                    links = `
                        <button class="tag tag-report-full"   onclick="downloadReport(${run.id}, 'full', this)">üìÅ Full Report</button>
                        <button class="tag tag-report-single" onclick="downloadReport(${run.id}, 'single', this)">üìÑ Single Page</button>
                    `;
                    if (!isSuccess) {
                        links += `<span class="tag tag-failed">‚ö† Tests failed</span>`;
                    }
                } else if (isRunning) {
                    links = `<span class="tag tag-pending">‚è≥ Running‚Ä¶ reports soon</span>`;
                }

                container.innerHTML += `
                    <div class="workflow-item">
                        <div class="workflow-header">
                            <span class="workflow-status status-${statusKey}">${statusKey}</span>
                            <span class="workflow-run-number">Run #${run.run_number}</span>
                            <span class="workflow-date">${date}</span>
                        </div>
                        <div class="workflow-links">
                            ${links}
                            <a href="${run.html_url}" target="_blank" class="tag tag-github">üîó GitHub</a>
                        </div>
                    </div>
                `;
            });
        }

        // ============================================================
        // DOWNLOAD ARTIFACT DIRECTLY ‚Äî no backend needed
        //   1. Fetch artifact list for the run
        //   2. Find the right artifact (full or single)
        //   3. Fetch the ZIP with Authorization header
        //   4. Convert to Blob ‚Üí trigger browser download
        // ============================================================
        async function downloadReport(runId, type, btn) {
            const originalHTML = btn.innerHTML;

            btn.disabled  = true;
            btn.innerHTML = '<span class="loader" style="width:12px;height:12px;border-width:2px;"></span> Downloading‚Ä¶';

            try {
                // 1. Get artifacts
                const artRes  = await fetch(`${API_BASE}/actions/runs/${runId}/artifacts`, { headers });
                const artData = await artRes.json();

                if (!artRes.ok) throw new Error('Could not fetch artifact list.');

                // 2. Find correct artifact
                const targetName = type === 'single' ? 'allure-report-single-file' : 'allure-report-full';
                const artifact   = artData.artifacts.find(a => a.name === targetName);

                if (!artifact) throw new Error('Report not found. Workflow may still be generating it.');

                // 3. Download ZIP
                const zipRes = await fetch(
                    `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/actions/artifacts/${artifact.id}/zip`,
                    { headers }
                );

                if (!zipRes.ok) throw new Error('Download failed. Check token permissions.');

                // 4. Blob ‚Üí browser download
                const blob = await zipRes.blob();
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement('a');
                a.href     = url;
                a.download = type === 'single'
                    ? `allure-single-run-${runId}.zip`
                    : `allure-full-run-${runId}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('success', `‚úÖ ${type === 'single' ? 'Single Page' : 'Full'} report downloaded! Extract the ZIP and open <strong>index.html</strong>.`);

            } catch (e) {
                showStatus('error', `‚ùå Download failed: ${e.message}`);
            } finally {
                btn.disabled  = false;
                btn.innerHTML = originalHTML;
            }
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function showStatus(type, html) {
            const el = document.getElementById('status');
            el.className = 'status ' + type;
            el.innerHTML = html;
        }

        // ============================================================
        // INIT + AUTO REFRESH every 30s
        // ============================================================
        window.addEventListener('load', loadWorkflows);
        setInterval(loadWorkflows, 30000);
    </script>
</body>
</html>
